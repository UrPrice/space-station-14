name: "Auto review Teams"

on:
  pull_request_target:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review

jobs:
  assign_review_teams:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      # затычка, как будет время и желание - переписать скрипт на самостоятельную проверку изменённых файлов, а не на опору в виде Labels: PR
      - name: Wait for labels to be added
        run: sleep 5

      - uses: actions/github-script@v6
        name: check team info
        with:
          script: |
            const { data: teams } = await github.rest.teams.list({
              org: 'SerbiaStrong-220',
              per_page: 100
            });

            const reviewTeams = teams.filter(t => t.name.includes('Review') || t.slug.includes('review'));
            console.log('Available review teams:');
            reviewTeams.forEach(t => {
              console.log(`  - ${t.name} (slug: ${t.slug}, id: ${t.id})`);
            });

            const { data: repoTeams } = await github.rest.teams.listByRepo({
              org: 'SerbiaStrong-220',
              repo: 'space-station-14',
              per_page: 100
            });

            console.log('Teams in repository:');
            repoTeams.forEach(t => {
              console.log(`  - ${t.name} (slug: ${t.slug}, permission: ${t.permission})`);
            });


      - uses: actions/github-script@v6
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            console.log('PR Number:', prNumber);

            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const prLabels = pullRequest.labels.map(label => label.name);
            console.log('Found labels:', prLabels);

            const labelTeamMap = {
              'Changes: C#': 'review-code',
              'Changes: Localization': 'review-code',
              'Changes: Prototypes': 'review-code',
              'Changes: Shaders': 'review-code',
              'Changes: UI': 'review-code',
              'Changes: Sprites': 'review-sprite',
              'Changes: Map': 'review-map'
            };

            const teamsToAdd = new Set();
            for (const label of prLabels) {
              if (labelTeamMap[label]) {
                console.log(`Mapping found: "${label}" → "${labelTeamMap[label]}"`);
                teamsToAdd.add(labelTeamMap[label]);
              } else {
                console.log(`No mapping for label: "${label}"`);
              }
            }

            console.log('Teams to add:', Array.from(teamsToAdd));

            if (teamsToAdd.size > 0) {
              try {
                console.log('Sending request with teams:', Array.from(teamsToAdd));
                const response = await github.rest.pulls.requestReviewers({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  team_reviewers: Array.from(teamsToAdd)
                });
                console.log('Team add: ${Array.from(teamsToAdd).join(', ')}');
                console.log('Response status:', response.status);
              } catch (error) {
                console.log('Full error:', error);
                console.log('Error message:', error.message);
                console.log('Error status:', error.status);
                console.log('Error data:', error.response?.data);
              }
            } else {
              console.log('Labels not found');
            }
